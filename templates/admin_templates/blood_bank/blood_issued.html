{% extends 'base.html' %}

{% block title %}Blood Issuance Management{% endblock %}
{% block page %}Blood Bank - Issuance Records{% endblock %}

{% block body %}
    <div class="container-fluid">
        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary bg-opacity-10 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-primary">Total Issuances</h6>
                                <h3>{{ issuances|length }}</h3>
                            </div>
                            <i class="ri-drop-fill fs-1 text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success bg-opacity-10 border-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-success">Completed</h6>
                                <h3>{{ issuances|selectattr('status', 'equalto', 'Completed')|list|length }}</h3>
                            </div>
                            <i class="ri-checkbox-circle-fill fs-1 text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning bg-opacity-10 border-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-warning">Pending</h6>
                                <h3>{{ issuances|selectattr('status', 'equalto', 'Pending')|list|length }}</h3>
                            </div>
                            <i class="ri-time-line fs-1 text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger bg-opacity-10 border-danger">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-danger">Cancelled</h6>
                                <h3>{{ issuances|selectattr('status', 'equalto', 'Cancelled')|list|length }}</h3>
                            </div>
                            <i class="ri-close-circle-fill fs-1 text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Blood Issuance Records</h5>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addIssuanceModal">
                        <i class="ri-add-line me-1"></i> New Issuance
                    </button>
                    <button class="btn btn-outline-secondary ms-2" data-bs-toggle="modal"
                            data-bs-target="#restoreModal">
                        <i class="ri-archive-line me-1"></i> View Archive
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <div class="table-responsive">
                    <table class="table table-hover table-bordered" id="issuanceTable">
                        <thead class="table-light">
                        <tr>
                            <th>Issue ID</th>
                            <th>Patient</th>
                            <th>Blood Product</th>
                            <th>Blood Type</th>
                            <th>Component</th>
                            <th>Quantity</th>
                            <th>Issue Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for issuance in issuances %}
                            <tr class="{% if issuance.status == 'Completed' %}table-success{% elif issuance.status == 'Cancelled' %}table-danger{% elif issuance.status == 'Pending' %}table-warning{% endif %}">
                                <td>{{ issuance.issue_id }}</td>
                                <td>
                                    <strong>{{ issuance.patient_name }}</strong><br>
                                    <small>ID: {{ issuance.patient_id }}</small>
                                </td>
                                <td>{{ issuance.blood_product.product_code }}</td>
                                <td>{{ issuance.blood_type }}</td>
                                <td>{{ issuance.component_type }}</td>
                                <td>{{ issuance.quantity }} units</td>
                                <td>{{ issuance.issue_date.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    {% if issuance.status == 'Completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% elif issuance.status == 'Pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% else %}
                                        <span class="badge bg-danger">Cancelled</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" data-bs-toggle="modal"
                                                data-bs-target="#viewModal{{ issuance.id }}">
                                            <i class="ri-eye-line"></i>
                                        </button>
                                        <button class="btn btn-outline-success" data-bs-toggle="modal"
                                                data-bs-target="#editModal{{ issuance.id }}">
                                            <i class="ri-edit-line"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" data-bs-toggle="modal"
                                                data-bs-target="#deleteModal{{ issuance.id }}">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Issuance Modal - Redesigned -->
    <div class="modal fade" id="addIssuanceModal" tabindex="-1" aria-labelledby="addIssuanceModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="addIssuanceModalLabel">
                        <i class="ri-drop-line me-2"></i>New Blood Issuance
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ ADMIN + BLOOD_BANK_ADD_ISSUED }}" id="issuanceForm">
                    <div class="modal-body">
                        <!-- Progress Steps -->
                        <div class="steps mb-4">
                            <div class="step active" data-step="1">
                                <div class="step-circle">1</div>
                                <div class="step-label">Patient Info</div>
                            </div>
                            <div class="step" data-step="2">
                                <div class="step-circle">2</div>
                                <div class="step-label">Blood Details</div>
                            </div>
                            <div class="step" data-step="3">
                                <div class="step-circle">3</div>
                                <div class="step-label">Issuance Info</div>
                            </div>
                            <div class="step" data-step="4">
                                <div class="step-circle">4</div>
                                <div class="step-label">Review</div>
                            </div>
                        </div>

                        <!-- Step 1: Patient Information -->
                        <div class="step-content active" id="step-1">
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="ri-user-line me-2"></i> Patient Information</h6>
                                </div>
                                <div class="card-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="isExistingPatient"
                                           name="is_existing_patient">
                                    <label class="form-check-label fw-bold" for="isExistingPatient">
                                        <i class="ri-user-search-line me-1"></i> Existing patient
                                    </label>
                                </div>

                                    <div id="patientIdSection" class="mb-3" style="display: none;">
                                        <div class="row align-items-end">
                                        <div class="col-md-8">
                                            <label class="form-label">Patient ID <span
                                                    class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="patientIdInput"
                                                   name="patient_id" placeholder="Enter patient ID">
                                        </div>
                                            <div class="col-md-4">
                                                <button type="button" class="btn btn-outline-primary"
                                                        id="fetchPatientBtn">
                                                    <i class="ri-search-line me-1"></i> Verify
                                            </button>
                                        </div>
                                    </div>
                                        <div id="patientValidationMsg" class="small mt-2 text-muted"></div>
                                    </div>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Full Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="patient_name" id="patientName"
                                               required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Age</label>
                                        <input type="number" class="form-control" name="patient_age" id="patientAge"
                                               min="0" max="120">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Gender</label>
                                        <select class="form-select" name="patient_gender" id="patientGender">
                                            <option value="">Select</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" name="patient_email" id="patientEmail"
                                               placeholder="patient@example.com">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Phone</label>
                                        <input type="tel" class="form-control" name="patient_phone" id="patientPhone"
                                               placeholder="+91 9876543210">
                                    </div>
                                </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="ri-close-line me-1"></i> Cancel
                                </button>
                                <button type="button" class="btn btn-primary next-step" data-next="2">
                                    Next <i class="ri-arrow-right-line ms-1"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Blood Product Information -->
                        <div class="step-content" id="step-2">
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="ri-drop-line me-2"></i> Blood Product Details</h6>
                            </div>
                                <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Blood Type <span class="text-danger">*</span></label>
                                        <select class="form-select" name="blood_type" id="bloodTypeSelect" required>
                                            <option value="">Select Blood Type</option>
                                            {% for bt in ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'] %}
                                                <option value="{{ bt }}">{{ bt }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Component <span class="text-danger">*</span></label>
                                        <select class="form-select" name="component_type" id="componentTypeSelect"
                                                required>
                                            <option value="">Select Component</option>
                                            <option value="Whole Blood">Whole Blood</option>
                                            <option value="Red Blood Cells">Red Blood Cells</option>
                                            <option value="Plasma">Plasma</option>
                                            <option value="Platelets">Platelets</option>
                                            <option value="Cryoprecipitate">Cryoprecipitate</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Quantity (units) <span
                                                class="text-danger">*</span></label>
                                        <input type="number" class="form-control" name="quantity" id="quantityInput"
                                               min="1" required>
                                    </div>
                                </div>

                                    <!-- Availability Status -->
                                    <div class="mt-3">
                                        <div class="card" id="availabilityCard" style="display: none;">
                                            <div class="card-body p-3">
                                                <div class="d-flex align-items-center">
                                                    <div class="flex-shrink-0">
                                                        <i class="ri-information-line fs-4" id="availabilityIcon"></i>
                                                    </div>
                                                    <div class="flex-grow-1 ms-3">
                                                        <h6 class="mb-0" id="availabilityTitle">Checking
                                                            availability...</h6>
                                                        <small class="text-muted" id="availabilityText"></small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cost Estimate -->
                                    <div class="mt-3">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="card-title mb-1">Estimated Cost</h6>
                                                        <p class="mb-0 small" id="costEstimateText">Select blood type
                                                            and component</p>
                                                    </div>
                                                    <h4 class="mb-0 text-primary" id="costEstimateAmount">₹0</h4>
                                                    <input type="hidden" name="amounts" id="amounts">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-check form-switch mt-3">
                                        <input class="form-check-input" type="checkbox" name="is_urgent" id="isUrgent">
                                        <label class="form-check-label" for="isUrgent">Mark as urgent request</label>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-primary prev-step" data-prev="1">
                                    <i class="ri-arrow-left-line me-1"></i> Back
                                </button>
                                <button type="button" class="btn btn-primary next-step" data-next="3">
                                    Next <i class="ri-arrow-right-line ms-1"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Issuance Details -->
                        <div class="step-content" id="step-3">
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="ri-calendar-line me-2"></i> Issuance Details</h6>
                            </div>
                                <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Issue Date <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" name="issue_date" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Transfusion Date</label>
                                        <input type="date" class="form-control" name="transfusion_date">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Status <span class="text-danger">*</span></label>
                                        <select class="form-select" name="status" required>
                                            <option value="Pending">Pending</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Cancelled">Cancelled</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Reason for Issuance</label>
                                        <textarea class="form-control" name="issue_reason" rows="2"
                                                  placeholder="Enter the reason for blood issuance"></textarea>
                                    </div>
                                </div>
                            </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="ri-money-dollar-circle-line me-2"></i> Payment
                                        Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Amount (₹) <span
                                                    class="text-danger">*</span></label>
                                            <input type="number" class="form-control" name="payment_amount"
                                                   id="paymentAmount" step="0.01" min="0" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Payment Status</label>
                                            <select class="form-select" name="payment_status">
                                                <option value="unpaid">Unpaid</option>
                                                <option value="paid">Paid</option>
                                                <option value="pending">Pending</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Payment Date</label>
                                            <input type="date" class="form-control" name="payment_date">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Payment Notes</label>
                                            <textarea class="form-control" name="payment_remarks" rows="2"
                                                      placeholder="Any additional payment details"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-primary prev-step" data-prev="2">
                                    <i class="ri-arrow-left-line me-1"></i> Back
                                </button>
                                <button type="button" class="btn btn-primary next-step" data-next="4">
                                    Next <i class="ri-arrow-right-line ms-1"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 4: Review and Submit -->
                        <div class="step-content" id="step-4">
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="ri-file-text-line me-2"></i> Review Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-primary mb-3"><i class="ri-user-line me-1"></i> Patient
                                                Details</h6>
                                            <div class="mb-2">
                                                <strong>Name:</strong> <span id="reviewPatientName">-</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Age/Gender:</strong> <span id="reviewPatientAgeGender">-</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Contact:</strong> <span id="reviewPatientContact">-</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-primary mb-3"><i class="ri-drop-line me-1"></i> Blood
                                                Details</h6>
                                            <div class="mb-2">
                                                <strong>Blood Type:</strong> <span id="reviewBloodType">-</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Component:</strong> <span id="reviewComponent">-</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Quantity:</strong> <span id="reviewQuantity">-</span> units
                                            </div>
                                            <div class="mb-2">
                                                <strong>Estimated Cost:</strong> <span id="reviewCost">₹0</span>
                                            </div>
                                    </div>
                                </div>

                                    <hr class="my-3">

                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-primary mb-3"><i class="ri-calendar-line me-1"></i> Issuance
                                                Details</h6>
                                            <div class="mb-2">
                                                <strong>Issue Date:</strong> <span id="reviewIssueDate">-</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Status:</strong> <span id="reviewStatus">-</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Urgent:</strong> <span id="reviewUrgent">No</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-primary mb-3"><i
                                                    class="ri-money-dollar-circle-line me-1"></i> Payment</h6>
                                            <div class="mb-2">
                                                <strong>Amount:</strong> <span id="reviewPaymentAmount">₹0</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Status:</strong> <span id="reviewPaymentStatus">Unpaid</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        <label class="form-label">Additional Notes</label>
                                        <textarea class="form-control" name="remarks" rows="3"
                                                  placeholder="Any additional remarks or instructions"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-primary prev-step" data-prev="3">
                                    <i class="ri-arrow-left-line me-1"></i> Back
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="ri-check-line me-1"></i> Submit Issuance
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        /* Steps styling */
        .steps {
            display: flex;
            justify-content: space-between;
            position: relative;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e9ecef;
            z-index: 0;
        }

        .step {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .step-label {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .step.active .step-circle {
            background-color: #0d6efd;
            color: white;
        }

        .step.active .step-label {
            color: #0d6efd;
            font-weight: 500;
        }

        /* Step content */
        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }
    </style>


    <!-- Issuance Modals -->
    {% for issuance in issuances %}
        <!-- View Modal -->
        <div class="modal fade" id="viewModal{{ issuance.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">Issuance Details: {{ issuance.issue_id }}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-info bg-opacity-10">
                                        <h6 class="mb-0"><i class="ri-user-line me-2"></i>Patient Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Patient ID:</strong> {{ issuance.patient_id }}</p>
                                        <p><strong>Name:</strong> {{ issuance.patient_name }}</p>
                                        <p><strong>Age:</strong> {{ issuance.patient_age or 'N/A' }}</p>
                                        <p><strong>Gender:</strong> {{ issuance.patient_gender or 'N/A' }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-info bg-opacity-10">
                                        <h6 class="mb-0"><i class="ri-drop-line me-2"></i>Blood Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Product ID:</strong> {{ issuance.blood_product_id }}</p>
                                        <p><strong>Blood Type:</strong> {{ issuance.blood_type }}</p>
                                        <p><strong>Component:</strong> {{ issuance.component_type }}</p>
                                        <p><strong>Quantity:</strong> {{ issuance.quantity }} units</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-info bg-opacity-10">
                                        <h6 class="mb-0"><i class="ri-file-text-line me-2"></i>Issuance Details</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <p><strong>Issue
                                                    Date:</strong> {{ issuance.issue_date.strftime('%d/%m/%Y') }}</p>
                                                <p><strong>Status:</strong>
                                                    {% if issuance.status == 'Completed' %}
                                                        <span class="badge bg-success">Completed</span>
                                                    {% elif issuance.status == 'Pending' %}
                                                        <span class="badge bg-warning">Pending</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">Cancelled</span>
                                                    {% endif %}
                                                </p>
                                            </div>
                                            <div class="col-md-4">
                                                <p><strong>Doctor:</strong> {{ issuance.doctor_name or 'N/A' }}</p>
                                                <p><strong>Transfusion
                                                    Date:</strong> {{ issuance.transfusion_date.strftime('%d/%m/%Y') if issuance.transfusion_date else 'N/A' }}
                                                </p>
                                            </div>
                                            <div class="col-md-4">
                                                <p><strong>Issued
                                                    By:</strong> {{ issuance.issued_by.username if issuance.issued_by else 'System' }}
                                                </p>
                                                <p><strong>Last
                                                    Updated:</strong> {{ issuance.updated_at.strftime('%d/%m/%Y %H:%M') if issuance.updated_at else 'N/A' }}
                                                </p>
                                            </div>
                                            <div class="col-12 mt-2">
                                                <p><strong>Reason:</strong> {{ issuance.issue_reason or 'N/A' }}</p>
                                                <p><strong>Remarks:</strong> {{ issuance.remarks or 'N/A' }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div class="modal fade" id="editModal{{ issuance.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">Edit Issuance: {{ issuance.issue_id }}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <form method="POST" action="{{ ADMIN + BLOOD_BANK_EDIT_ISSUED }}/{{ issuance.id }}">
                        <div class="modal-body">
                            <div class="row g-3">
                                <!-- Patient Information -->
                                <div class="col-md-6">
                                    <label class="form-label">Patient ID <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="patient_id"
                                           value="{{ issuance.patient_id }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Patient Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="patient_name"
                                           value="{{ issuance.patient_name }}" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Patient Age</label>
                                    <input type="number" class="form-control" name="patient_age"
                                           value="{{ issuance.patient_age or '' }}" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Patient Gender</label>
                                    <select class="form-select" name="patient_gender" readonly>
                                        <option value="">Select Gender</option>
                                        <option value="Male"
                                                {% if issuance.patient_gender == 'Male' %}selected{% endif %}>Male
                                        </option>
                                        <option value="Female"
                                                {% if issuance.patient_gender == 'Female' %}selected{% endif %}>Female
                                        </option>
                                        <option value="Other"
                                                {% if issuance.patient_gender == 'Other' %}selected{% endif %}>Other
                                        </option>
                                    </select>
                                </div>

                                <!-- Blood Product Information -->
                                <div class="col-md-6">
                                    <label class="form-label">Blood Product ID <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="blood_product_id"
                                           value="{{ issuance.blood_product_id }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Blood Type <span class="text-danger">*</span></label>
                                    <select class="form-select" name="blood_type" required>
                                        {% for bt in ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'] %}
                                            <option value="{{ bt }}"
                                                    {% if issuance.blood_type == bt %}selected{% endif %}>{{ bt }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Component Type <span class="text-danger">*</span></label>
                                    <select class="form-select" name="component_type" required>
                                        <option value="Whole Blood"
                                                {% if issuance.component_type == 'Whole Blood' %}selected{% endif %}>
                                            Whole Blood
                                        </option>
                                        <option value="Red Blood Cells"
                                                {% if issuance.component_type == 'Red Blood Cells' %}selected{% endif %}>
                                            Red Blood Cells
                                        </option>
                                        <option value="Plasma"
                                                {% if issuance.component_type == 'Plasma' %}selected{% endif %}>Plasma
                                        </option>
                                        <option value="Platelets"
                                                {% if issuance.component_type == 'Platelets' %}selected{% endif %}>
                                            Platelets
                                        </option>
                                        <option value="Cryoprecipitate"
                                                {% if issuance.component_type == 'Cryoprecipitate' %}selected{% endif %}>
                                            Cryoprecipitate
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Quantity (units) <span
                                            class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="quantity"
                                           value="{{ issuance.quantity }}" min="1" required>
                                </div>

                                <!-- Issuance Details -->
                                <div class="col-md-6">
                                    <label class="form-label">Issue Date <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" name="issue_date"
                                           value="{{ issuance.issue_date.strftime('%Y-%m-%d') }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Transfusion Date</label>
                                    <input type="date" class="form-control" name="transfusion_date"
                                           value="{{ issuance.transfusion_date.strftime('%Y-%m-%d') if issuance.transfusion_date else '' }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Status <span class="text-danger">*</span></label>
                                    <select class="form-select" name="status" required>
                                        <option value="Pending"
                                                {% if issuance.status == 'Pending' %}selected{% endif %}>Pending
                                        </option>
                                        <option value="Completed"
                                                {% if issuance.status == 'Completed' %}selected{% endif %}>Completed
                                        </option>
                                        <option value="Cancelled"
                                                {% if issuance.status == 'Cancelled' %}selected{% endif %}>Cancelled
                                        </option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Issue Reason</label>
                                    <textarea class="form-control" name="issue_reason"
                                              rows="2">{{ issuance.issue_reason or '' }}</textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Remarks</label>
                                    <textarea class="form-control" name="remarks"
                                              rows="2">{{ issuance.remarks or '' }}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">Update Record</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delete Modal -->
        <div class="modal fade" id="deleteModal{{ issuance.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Confirm Archive</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to archive this issuance record?</p>
                        <div class="alert alert-warning">
                            <i class="ri-alert-line me-2"></i>This will remove the record from active listings but
                            preserve it in the archive.
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <p><strong>Issuance ID:</strong> {{ issuance.issue_id }}</p>
                                <p><strong>Patient:</strong> {{ issuance.patient_name }}</p>
                                <p><strong>Blood Product:</strong> {{ issuance.blood_product_id }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <form method="POST" action="{{ ADMIN + BLOOD_BANK_DELETE_ISSUED }}/{{ issuance.id }}">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Archive Record</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}

    <!-- Restore Modal -->
    <div class="modal fade" id="restoreModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="ri-archive-line me-2"></i>Archived Issuance Records</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if deleted_issuances %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>Issue ID</th>
                                    <th>Patient</th>
                                    <th>Blood Product</th>
                                    <th>Quantity</th>
                                    <th>Issue Date</th>
                                    <th>Archived On</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for issuance in deleted_issuances %}
                                    <tr>
                                        <td>{{ issuance.issue_id }}</td>
                                        <td>{{ issuance.patient_name }}</td>
                                        <td>{{ issuance.blood_product_id }}</td>
                                        <td>{{ issuance.quantity }} units</td>
                                        <td>{{ issuance.issue_date.strftime('%d/%m/%Y') }}</td>
                                        <td>{{ issuance.deleted_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                        <td>
                                            <form method="POST"
                                                  action="{{ ADMIN + BLOOD_BANK_RESTORE_ISSUED }}/{{ issuance.id }}">
                                                <button type="submit" class="btn btn-sm btn-success">
                                                    <i class="ri-refresh-line me-1"></i> Restore
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="ri-information-line me-2"></i>No archived issuance records found
                        </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block heardLink %}
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendor/datatables/dataTables.bs5.css') }}">
    <link rel="stylesheet"
          href="{{ url_for('static', filename='assets/vendor/datatables/dataTables.bs5-custom.css') }}">
{% endblock %}

{% block footerLink %}
    <!-- DataTables JS -->
    <script src="{{ url_for('static', filename='assets/vendor/datatables/dataTables.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/vendor/datatables/dataTables.bootstrap.min.js') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize DataTable
            $('#issuanceTable').DataTable({
                responsive: true,
                order: [[6, 'desc']] // Sort by issue date by default
            });

            // Set default issue date to today
            const today = new Date();
            const issueDate = today.toISOString().split('T')[0];
            document.querySelector('#addIssuanceModal input[name="issue_date"]').value = issueDate;


        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Toggle patient ID section
            const isExistingPatient = document.getElementById('isExistingPatient');
            const patientIdSection = document.getElementById('patientIdSection');

            isExistingPatient.addEventListener('change', function () {
                if (this.checked) {
                    patientIdSection.style.display = 'block';
                } else {
                    patientIdSection.style.display = 'none';
                    resetPatientFields();
                }
            });

            // Enhanced patient verification with error handling
            document.getElementById('fetchPatientBtn').addEventListener('click', async function () {
                const patientId = document.getElementById('patientIdInput').value.trim();
                const validationMsg = document.getElementById('patientValidationMsg');

                if (!patientId) {
                    showValidationMessage(validationMsg, 'Please enter a patient ID', 'danger');
                    return;
                }

                try {
                    showValidationMessage(validationMsg, 'Verifying patient...', 'info', true);

                    const response = await fetch(`/admin/get-patient/${patientId}`);

                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Auto-fill patient details
                    fillPatientDetails(data);
                    showValidationMessage(validationMsg, `Patient verified: ${data.first_name} ${data.last_name}`, 'success');

                } catch (error) {
                    console.error('Error:', error);
                    showValidationMessage(validationMsg, error.message || 'Error verifying patient', 'danger');
                    resetPatientFields();
                }
            });

            // Helper functions
            function fillPatientDetails(data) {
                document.getElementById('patientName').value = data.full_name || `${data.first_name || ''} ${data.last_name || ''}`.trim();
                document.getElementById('patientAge').value = data.age || '';
                document.getElementById('patientGender').value = data.gender || '';
                document.getElementById('patientEmail').value = data.email || '';
                document.getElementById('patientPhone').value = data.phone || '';
            }

            function resetPatientFields() {
                document.getElementById('patientName').value = '';
                document.getElementById('patientAge').value = '';
                document.getElementById('patientGender').value = '';
                document.getElementById('patientEmail').value = '';
                document.getElementById('patientPhone').value = '';
            }

            function showValidationMessage(element, message, type, loading = false) {
                const icons = {
                    info: 'ri-information-line',
                    success: 'ri-checkbox-circle-line',
                    danger: 'ri-error-warning-line',
                    loading: 'ri-loader-4-line spin'
                };

                const iconClass = loading ? icons.loading : icons[type] || '';
                const icon = iconClass ? `<i class="${iconClass} me-1"></i>` : '';

                element.innerHTML = `<span class="text-${type}">${icon}${message}</span>`;
            }

            // Set default issue date to today
            document.querySelector('input[name="issue_date"]').valueAsDate = new Date();
        });
    </script>

    <script>
        // Base prices for blood components
        const bloodPrices = {
            'Whole Blood': 1000,
            'Red Blood Cells': 1200,
            'Plasma': 1500,
            'Platelets': 1800,
            'Cryoprecipitate': 2000
        };

        // Initialize date picker
        document.addEventListener('DOMContentLoaded', function () {
            const today = new Date();
            document.querySelector('input[name="issue_date"]').valueAsDate = today;

            // Step navigation
            document.querySelectorAll('.next-step').forEach(button => {
                button.addEventListener('click', function () {
                    const nextStep = this.getAttribute('data-next');
                    navigateToStep(nextStep);
                    updateReviewSection();
                });
            });

            document.querySelectorAll('.prev-step').forEach(button => {
                button.addEventListener('click', function () {
                    const prevStep = this.getAttribute('data-prev');
                    navigateToStep(prevStep);
                });
            });

            // Existing patient toggle
            document.getElementById('isExistingPatient').addEventListener('change', function () {
                document.getElementById('patientIdSection').style.display = this.checked ? 'block' : 'none';
            });

            // Initialize first step
            navigateToStep('1');
        });

        function navigateToStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(step => {
                step.classList.remove('active');
            });

            // Show selected step
            document.getElementById(`step-${stepNumber}`).classList.add('active');

            // Update step indicators
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
                if (parseInt(step.getAttribute('data-step')) <= parseInt(stepNumber)) {
                    step.classList.add('active');
                }
            });
        }

        function updateReviewSection() {
            // Patient details
            document.getElementById('reviewPatientName').textContent =
                document.getElementById('patientName').value || '-';

            const age = document.getElementById('patientAge').value;
            const gender = document.getElementById('patientGender').value;
            document.getElementById('reviewPatientAgeGender').textContent =
                (age ? age + ' years' : '-') + (gender ? '/' + gender : '');

            const email = document.getElementById('patientEmail').value;
            const phone = document.getElementById('patientPhone').value;
            document.getElementById('reviewPatientContact').textContent =
                (phone || '-') + (email ? ' | ' + email : '');

            // Blood details
            document.getElementById('reviewBloodType').textContent =
                document.getElementById('bloodTypeSelect').value || '-';
            document.getElementById('reviewComponent').textContent =
                document.getElementById('componentTypeSelect').value || '-';
            document.getElementById('reviewQuantity').textContent =
                document.getElementById('quantityInput').value || '0';
            document.getElementById('reviewCost').textContent =
                document.getElementById('costEstimateAmount').textContent || '₹0';

            // Issuance details
            document.getElementById('reviewIssueDate').textContent =
                document.querySelector('input[name="issue_date"]').value || '-';
            document.getElementById('reviewStatus').textContent =
                document.querySelector('select[name="status"]').value || '-';
            document.getElementById('reviewUrgent').textContent =
                document.getElementById('isUrgent').checked ? 'Yes' : 'No';

            // Payment details
            document.getElementById('reviewPaymentAmount').textContent =
                '₹' + (parseFloat(document.getElementById('paymentAmount').value || 0).toFixed(2));
            document.getElementById('reviewPaymentStatus').textContent =
                document.querySelector('select[name="payment_status"]').value || 'Unpaid';
        }

        // Check blood availability
        function checkAvailability() {
            let bloodTypeSelect = document.getElementById('bloodTypeSelect').value;
            console.log(bloodTypeSelect)
            const componentType = document.getElementById('componentTypeSelect').value;
            const quantity = document.getElementById('quantityInput').value;

            // Show loading state
            const availabilityCard = document.getElementById('availabilityCard');
            availabilityCard.style.display = 'block';
            document.getElementById('availabilityTitle').textContent = 'Checking availability...';
            document.getElementById('availabilityText').textContent = 'Please wait while we check stock levels';
            document.getElementById('availabilityIcon').className = 'ri-loader-4-line fs-4 animate-spin';

            setTimeout(() => {
                // Get the selected values properly
                const bloodTypeSelect = document.getElementById('bloodTypeSelect');
                const selectedBloodType = bloodTypeSelect.options[bloodTypeSelect.selectedIndex].value;
                const selectedComponentType = document.getElementById('componentTypeSelect').value;
                const quantity = document.getElementById('quantityInput').value;

                // Create JSON payload
                const requestData = {
                    blood_type: selectedBloodType,
                    component_type: selectedComponentType,
                    quantity: parseInt(quantity) || 0
                };

                // Make the fetch request with JSON
                fetch('/patient/api/blood-availability', {
                    method: 'POST',  // Using POST for JSON data
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('API Response:', data);

                        const available = data.is_available && data.quantity >= requestData.quantity;
                        console.log(available)
                        const icon = document.getElementById('availabilityIcon');
                        const title = document.getElementById('availabilityTitle');
                        const text = document.getElementById('availabilityText');

                        if (available) {
                            availabilityCard.className = 'card mb-3 bg-success bg-opacity-10';
                            icon.className = 'ri-checkbox-circle-line fs-4 text-success';
                            title.textContent = 'Available';
                            title.className = 'mb-0 text-success';
                            text.textContent = `${data.quantity} units available for ${data.component_type}`;

                        } else {
                            availabilityCard.className = 'card mb-3 bg-danger bg-opacity-10';
                            icon.className = 'ri-close-circle-line fs-4 text-danger';
                            title.textContent = 'Not Available';
                            title.className = 'mb-0 text-danger';

                            if (data.quantity > 0) {
                                text.textContent = `Only ${data.quantity} units available (need ${requestData.quantity})`;
                            } else {
                                text.textContent = 'No stock available for this blood type and component';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking availability:', error);
                        availabilityCard.className = 'card mb-3 bg-warning bg-opacity-10';
                        document.getElementById('availabilityIcon').className = 'ri-error-warning-line fs-4 text-warning';
                        document.getElementById('availabilityTitle').textContent = 'Error checking availability';
                        document.getElementById('availabilityTitle').className = 'mb-0 text-warning';
                        document.getElementById('availabilityText').textContent = 'Please try again later';

                    });
            }, 1000);
            // Update cost estimate
            updateCostEstimate();
        }

        // Update cost estimate
        function updateCostEstimate() {
            const componentType = document.getElementById('componentTypeSelect').value;
            const quantity = document.getElementById('quantityInput').value || 0;

            if (componentType && bloodPrices[componentType]) {
                const totalCost = bloodPrices[componentType] * quantity;
                document.getElementById('costEstimateText').textContent =
                    `${quantity} unit(s) of ${componentType}`;
                document.getElementById('costEstimateAmount').textContent = `₹${totalCost.toLocaleString()}`;
                document.getElementById('amounts').value = totalCost;
                document.getElementById('paymentAmount').value = totalCost;
            } else {
                document.getElementById('costEstimateText').textContent =
                    'Select blood type and component to see cost';
                document.getElementById('costEstimateAmount').textContent = '₹0';
            }
        }

        // Event listeners
        document.getElementById('bloodTypeSelect').addEventListener('change', checkAvailability);
        document.getElementById('componentTypeSelect').addEventListener('change', checkAvailability);
        document.getElementById('quantityInput').addEventListener('input', checkAvailability);
    </script>
{% endblock %}