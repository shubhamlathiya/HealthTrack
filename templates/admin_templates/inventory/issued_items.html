{% extends 'base.html' %}

{% block title %}Issued Items Management{% endblock %}

{% block heardLink %}
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <style>
        .dataTables_wrapper .dataTables_filter input {
            margin-bottom: 10px;
        }

        .btn-action {
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .modal-body .form-group {
            margin-bottom: 1rem;
        }

        .stock-info {
            font-weight: bold;
            color: #007bff;
        }

        .stock-info.low {
            color: #dc3545; /* Red for low stock */
        }

        .badge-status-issued {
            background-color: #007bff;
            color: white;
        }

        .badge-status-returned {
            background-color: #28a745;
            color: white;
        }

        .badge-status-pending {
            background-color: #ffc107;
            color: #343a40;
        }

        .badge-status-requested {
            background-color: #17a2b8;
            color: white;
        }

        .badge-status-rejected {
            background-color: #6c757d;
            color: white;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container-fluid mt-4">
        <h1 class="h3 mb-4 text-gray-800">Issued Items Management</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Issued Items Data</h6>
                <div>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addIssuedItemModal">
                        <i class="fas fa-plus"></i> Add Issued Item
                    </button>
                    <div class="btn-group">
                        <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown"
                                aria-expanded="false">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ ADMIN }}{{ ISSUED_ITEMS_EXPORT }}/csv">CSV</a></li>
                            <li><a class="dropdown-item" href="{{ ADMIN }}{{ ISSUED_ITEMS_EXPORT }}/excel">Excel</a>
                            </li>
                            <li><a class="dropdown-item" href="{{ ADMIN }}{{ ISSUED_ITEMS_EXPORT }}/pdf">PDF</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" id="issuedItemsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="active-tab" data-bs-toggle="tab"
                                data-bs-target="#activeIssuedItems" type="button" role="tab"
                                aria-controls="activeIssuedItems" aria-selected="true">Active Issued Items
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="archived-tab" data-bs-toggle="tab"
                                data-bs-target="#archivedIssuedItems" type="button" role="tab"
                                aria-controls="archivedIssuedItems" aria-selected="false">Archived Issued Items
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="issuedItemsTabContent">
                    <div class="tab-pane fade show active" id="activeIssuedItems" role="tabpanel"
                         aria-labelledby="active-tab">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="activeIssuedItemsTable" width="100%" cellspacing="0">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Issued To</th>
                                <th>User Type</th>
                                <th>Issue Date</th>
                                <th>Return Date</th>
                                <th>Quantity</th>
                                <th>Status</th>
                                <th>Requested By</th>
                                <th>Approved By</th>
                                <th>Department</th>
                                <th>Purpose</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for item in active_issued_items %}
                                <tr>
                                    <td>{{ item.id }}</td>
                                    <td>{{ item.item.item_name if item.item else 'N/A' }}</td>
                                    <td>{{ item.item.category.name if item.item and item.item.category else 'N/A' }}</td>
                                    <td>{{ item.issued_to_name }}</td>
                                    <td>{{ item.user_type }}</td>
                                    <td>{{ item.issue_date.strftime('%Y-%m-%d') if item.issue_date else 'N/A' }}</td>
                                    <td>{{ item.return_date.strftime('%Y-%m-%d') if item.return_date else 'N/A' }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>
                                        <span class="badge rounded-pill badge-status-{{ item.status | lower }}">{{ item.status }}</span>
                                    </td>
                                    <td>{{ item.requested_by or 'N/A' }}</td>
                                    <td>{{ item.approved_by or 'N/A' }}</td>
                                    <td>{{ item.department or 'N/A' }}</td>
                                    <td>{{ item.purpose or 'N/A' }}</td>
                                    <td>{{ item.note or 'N/A' }}</td>
                                    <td>
                                        <button class="btn btn-info btn-sm btn-action" data-bs-toggle="modal"
                                                data-bs-target="#editIssuedItemModal"
                                                data-id="{{ item.id }}"
                                                data-item-id="{{ item.item_id }}"
                                                data-issued-to-name="{{ item.issued_to_name }}"
                                                data-issued-to-user-id="{{ item.issued_to_user_id }}"
                                                data-user-type="{{ item.user_type }}"
                                                data-issued-by="{{ item.issued_by }}"
                                                data-issue-date="{{ item.issue_date.strftime('%Y-%m-%d') if item.issue_date else '' }}"
                                                data-return-date="{{ item.return_date.strftime('%Y-%m-%d') if item.return_date else '' }}"
                                                data-quantity="{{ item.quantity }}"
                                                data-status="{{ item.status }}"
                                                data-note="{{ item.note }}"
                                                data-requested-by="{{ item.requested_by }}"
                                                data-approved-by="{{ item.approved_by }}"
                                                data-department="{{ item.department }}"
                                                data-purpose="{{ item.purpose }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        {% if item.status == 'Issued' and not item.return_date %}
                                            <button class="btn btn-warning btn-sm btn-action" data-bs-toggle="modal"
                                                    data-bs-target="#returnIssuedItemModal" data-id="{{ item.id }}"
                                                    data-item-name="{{ item.item.item_name if item.item else 'N/A' }}">
                                                <i class="fas fa-undo"></i> Return
                                            </button>
                                        {% elif item.status in ['Pending', 'Requested'] %}
                                            <button class="btn btn-success btn-sm btn-action" data-bs-toggle="modal"
                                                    data-bs-target="#approveRequestModal" data-id="{{ item.id }}"
                                                    data-item-name="{{ item.item.item_name if item.item else 'N/A' }}">
                                                <i class="fas fa-check"></i> Approve
                                            </button>
                                            <button class="btn btn-secondary btn-sm btn-action" data-bs-toggle="modal"
                                                    data-bs-target="#rejectRequestModal" data-id="{{ item.id }}"
                                                    data-item-name="{{ item.item.item_name if item.item else 'N/A' }}">
                                                <i class="fas fa-times"></i> Reject
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-danger btn-sm btn-action" data-bs-toggle="modal"
                                                data-bs-target="#deleteIssuedItemModal" data-id="{{ item.id }}"
                                                data-item-name="{{ item.item.item_name if item.item else 'N/A' }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    </div>

                    <div class="tab-pane fade" id="archivedIssuedItems" role="tabpanel" aria-labelledby="archived-tab">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="archivedIssuedItemsTable" width="100%"
                                   cellspacing="0">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Issued To</th>
                                    <th>User Type</th>
                                    <th>Issue Date</th>
                                    <th>Return Date</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Requested By</th>
                                    <th>Approved By</th>
                                    <th>Department</th>
                                    <th>Purpose</th>
                                    <th>Note</th>
                                    <th>Deleted At</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for item in archived_issued_items %}
                                    <tr>
                                        <td>{{ item.id }}</td>
                                        <td>{{ item.item.item_name if item.item else 'N/A' }}</td>
                                        <td>{{ item.item.category.name if item.item and item.item.category else 'N/A' }}</td>
                                        <td>{{ item.issued_to_name }}</td>
                                        <td>{{ item.user_type }}</td>
                                        <td>{{ item.issue_date.strftime('%Y-%m-%d') if item.issue_date else 'N/A' }}</td>
                                        <td>{{ item.return_date.strftime('%Y-%m-%d') if item.return_date else 'N/A' }}</td>
                                        <td>{{ item.quantity }}</td>
                                        <td>
                                            <span class="badge rounded-pill badge-status-{{ item.status | lower }}">{{ item.status }}</span>
                                        </td>
                                        <td>{{ item.requested_by or 'N/A' }}</td>
                                        <td>{{ item.approved_by or 'N/A' }}</td>
                                        <td>{{ item.department or 'N/A' }}</td>
                                        <td>{{ item.purpose or 'N/A' }}</td>
                                        <td>{{ item.note or 'N/A' }}</td>
                                        <td>{{ item.deleted_at.strftime('%Y-%m-%d %H:%M:%S') if item.deleted_at else 'N/A' }}</td>
                                        <td>
                                            <button class="btn btn-success btn-sm btn-action" data-bs-toggle="modal"
                                                    data-bs-target="#restoreIssuedItemModal" data-id="{{ item.id }}"
                                                    data-item-name="{{ item.item.item_name if item.item else 'N/A' }}">
                                                <i class="fas fa-undo"></i> Restore
                                            </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div class="modal fade" id="addIssuedItemModal" tabindex="-1" aria-labelledby="addIssuedItemModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addIssuedItemModalLabel">Add New Issued Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ ADMIN }}{{ ISSUED_ITEMS_ADD }}" method="POST" id="addIssuedItemForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="addItemId">Item Name <span class="text-danger">*</span></label>
                                    <select class="form-control" id="addItemId" name="item_id" required
                                            style="width: 100%;">
                                        <option value="">Select an Item</option>
                                    {% for item in items %}
                                        <option value="{{ item.id }}">{{ item.name }}</option>
                                    {% endfor %}
                                </select>
                                    <small class="form-text text-muted" id="addItemStockInfo">Available Stock: <span
                                            class="stock-value">Loading...</span></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="addQuantity">Quantity <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="addQuantity" name="quantity" min="1"
                                           required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="addUserType">User Type <span class="text-danger">*</span></label>
                                    <select class="form-control" id="addUserType" name="user_type" required>
                                        <option value="">Select User Type</option>
                                        {% for role in user_roles %}
                                            <option value="{{ role.name }}">{{ role.value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="addIssuedToUserId">Issued To User (Optional - if internal user)</label>
                                    <select class="form-control" id="addIssuedToUserId" name="issued_to_user_id"
                                            style="width: 100%;">
                                        <option value="">Select User</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="addIssuedToName">Issued To Name (e.g., student name, external client) <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addIssuedToName" name="issued_to_name" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="addIssueDate">Issue Date <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="addIssueDate" name="issue_date"
                                           value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
                            </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="addStatus">Status</label>
                                    <select class="form-control" id="addStatus" name="status">
                                        <option value="Issued">Issued</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Requested">Requested</option>
                                </select>
                            </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="addRequestedBy">Requested By (Optional)</label>
                                    <input type="text" class="form-control" id="addRequestedBy" name="requested_by">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="addApprovedBy">Approved By (Optional)</label>
                                    <input type="text" class="form-control" id="addApprovedBy" name="approved_by">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="addDepartment">Department (Optional)</label>
                                    <input type="text" class="form-control" id="addDepartment" name="department">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="addPurpose">Purpose (Optional)</label>
                                    <input type="text" class="form-control" id="addPurpose" name="purpose">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="addNote">Note</label>
                            <textarea class="form-control" id="addNote" name="note" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Issued Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editIssuedItemModal" tabindex="-1" aria-labelledby="editIssuedItemModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editIssuedItemModalLabel">Edit Issued Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="" method="POST" id="editIssuedItemForm">
                    <div class="modal-body">
                        <input type="hidden" name="id" id="editIssuedItemId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editItemId">Item Name <span class="text-danger">*</span></label>
                                    <select class="form-control" id="editItemId" name="item_id" required
                                            style="width: 100%;">
                                        <option value="">Select an Item</option>
                                        {% for item in items %}
                                            <option value="{{ item.id }}">{{ item.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted" id="editItemStockInfo">Available Stock: <span
                                            class="stock-value">Loading...</span></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editQuantity">Quantity <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="editQuantity" name="quantity" min="1"
                                           required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editUserType">User Type <span class="text-danger">*</span></label>
                                    <select class="form-control" id="editUserType" name="user_type" required>
                                        <option value="">Select User Type</option>
                                        {% for role in user_roles %}
                                            <option value="{{ role.name }}">{{ role.value }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editIssuedToUserId">Issued To User (Optional)</label>
                                    <select class="form-control" id="editIssuedToUserId" name="issued_to_user_id"
                                            style="width: 100%;">
                                        <option value="">Select User</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editIssuedToName">Issued To Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editIssuedToName" name="issued_to_name"
                                   required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editIssueDate">Issue Date <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="editIssueDate" name="issue_date"
                                           required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editReturnDate">Return Date (Optional)</label>
                                    <input type="date" class="form-control" id="editReturnDate" name="return_date">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editStatus">Status</label>
                                    <select class="form-control" id="editStatus" name="status">
                                        <option value="Issued">Issued</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Requested">Requested</option>
                                        <option value="Returned">Returned</option>
                                        <option value="Rejected">Rejected</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editRequestedBy">Requested By (Optional)</label>
                                    <input type="text" class="form-control" id="editRequestedBy" name="requested_by">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editApprovedBy">Approved By (Optional)</label>
                                    <input type="text" class="form-control" id="editApprovedBy" name="approved_by">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editDepartment">Department (Optional)</label>
                                    <input type="text" class="form-control" id="editDepartment" name="department">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editPurpose">Purpose (Optional)</label>
                            <input type="text" class="form-control" id="editPurpose" name="purpose">
                        </div>
                        <div class="form-group">
                            <label for="editNote">Note</label>
                            <textarea class="form-control" id="editNote" name="note" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="returnIssuedItemModal" tabindex="-1" aria-labelledby="returnIssuedItemModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="returnIssuedItemModalLabel">Confirm Return Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="" method="POST" id="returnIssuedItemForm">
                    <div class="modal-body">
                        Are you sure you want to mark "<span id="returnItemName"></span>" as returned?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Confirm Return</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="approveRequestModal" tabindex="-1" aria-labelledby="approveRequestModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="approveRequestModalLabel">Confirm Approval</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="" method="POST" id="approveRequestForm">
                    <div class="modal-body">
                        Are you sure you want to **APPROVE** the request for "<span id="approveItemName"></span>"? This
                        will mark it as "Issued".
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Approve Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="rejectRequestModal" tabindex="-1" aria-labelledby="rejectRequestModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectRequestModalLabel">Confirm Rejection</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="" method="POST" id="rejectRequestForm">
                    <div class="modal-body">
                        Are you sure you want to **REJECT** the request for "<span id="rejectItemName"></span>"? This
                        will mark it as "Rejected".
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-secondary">Reject Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteIssuedItemModal" tabindex="-1" aria-labelledby="deleteIssuedItemModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteIssuedItemModalLabel">Confirm Archive Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="" method="POST" id="deleteIssuedItemForm">
                <div class="modal-body">
                    Are you sure you want to **archive** issued item "<span id="deleteItemName"></span>"? This action
                    can be undone.
                </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Archive</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="restoreIssuedItemModal" tabindex="-1" aria-labelledby="restoreIssuedItemModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="restoreIssuedItemModalLabel">Confirm Restore Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="" method="POST" id="restoreIssuedItemForm">
                    <div class="modal-body">
                        Are you sure you want to **restore** issued item "<span id="restoreItemName"></span>"?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Restore</button>
                </div>
                </form>
            </div>
        </div>
    </div>


{% endblock %}

{% block footerLink %}

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function () {
            // Initialize DataTables


            // Initialize Select2 for item and user dropdowns
            // For 'add' modal
            $('#addItemId').select2({
                placeholder: "Select an Item",
                dropdownParent: $('#addIssuedItemModal')
            });
            $('#addIssuedToUserId').select2({
                placeholder: "Select User",
                dropdownParent: $('#addIssuedItemModal')
            });

            // For 'edit' modal
            $('#editItemId').select2({
                placeholder: "Select an Item",
                dropdownParent: $('#editIssuedItemModal')
            });
            $('#editIssuedToUserId').select2({
                placeholder: "Select User",
                dropdownParent: $('#editIssuedItemModal')
            });

            // Function to fetch available stock
            function fetchAvailableStock(itemId, stockInfoElement) {
                if (itemId) {
                    $.get(`{{ ADMIN }}/{{ API_GET_AVAILABLE_STOCK }}/${itemId}`, function (data) {
                        if (data.error) {
                            stockInfoElement.text('Error: ' + data.error).removeClass('stock-info').addClass('low');
                        } else {
                            stockInfoElement.find('.stock-value').text(data.available_stock);
                            stockInfoElement.removeClass('low');
                            if (data.available_stock < 5) { // Example: highlight low stock
                                stockInfoElement.addClass('low');
                            }
                        }
                    }).fail(function () {
                        stockInfoElement.text('Error fetching stock.').removeClass('stock-info').addClass('low');
                    });
                } else {
                    stockInfoElement.find('.stock-value').text('N/A');
                    stockInfoElement.removeClass('low');
                }
            }

            // --- Add Issued Item Modal Logic ---
            $('#addItemId').on('change', function () {
                const itemId = $(this).val();
                fetchAvailableStock(itemId, $('#addItemStockInfo'));
            });

            // Dynamic User dropdown for Add Modal
            $('#addUserType').on('change', function () {
                const roleName = $(this).val();
                const userSelect = $('#addIssuedToUserId');
                userSelect.empty().append('<option value="">Select User</option>');
                if (roleName) {
                    $.get(`{{ ADMIN }}/{{ API_GET_USERS_BY_ROLE }}/${roleName}`, function (data) {
                        data.users.forEach(function (user) {
                            userSelect.append(new Option(user.name, user.id));
                        });
                        userSelect.trigger('change'); // Notify Select2 that options have changed
                    }).fail(function () {
                        alert('Could not fetch users for the selected role.');
                    });
                }
            });

            // --- Edit Issued Item Modal Logic ---
            $('#editIssuedItemModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget); // Button that triggered the modal
                const id = button.data('id');
                const itemId = button.data('item-id');
                const issuedToName = button.data('issued-to-name');
                const issuedToUserId = button.data('issued-to-user-id');
                const userType = button.data('user-type');
                const issueDate = button.data('issue-date');
                const returnDate = button.data('return-date');
                const quantity = button.data('quantity');
                const status = button.data('status');
                const note = button.data('note');
                const requestedBy = button.data('requested-by');
                const approvedBy = button.data('approved-by');
                const department = button.data('department');
                const purpose = button.data('purpose');

                const modal = $(this);
                modal.find('#editIssuedItemForm').attr('action', `{{ ADMIN }}/{{ ISSUED_ITEMS_EDIT }}/${id}`);
                modal.find('#editIssuedItemId').val(id);
                modal.find('#editIssuedToName').val(issuedToName);
                modal.find('#editQuantity').val(quantity);
                modal.find('#editIssueDate').val(issueDate);
                modal.find('#editReturnDate').val(returnDate);
                modal.find('#editStatus').val(status);
                modal.find('#editNote').val(note);
                modal.find('#editRequestedBy').val(requestedBy);
                modal.find('#editApprovedBy').val(approvedBy);
                modal.find('#editDepartment').val(department);
                modal.find('#editPurpose').val(purpose);

                // Set item_id and trigger change to load stock info
                modal.find('#editItemId').val(itemId).trigger('change');
                fetchAvailableStock(itemId, $('#editItemStockInfo')); // Initial fetch for edit modal

                // Set user_type and dynamically load users
                modal.find('#editUserType').val(userType).trigger('change');

                // Fetch users for the selected role in edit modal
                const userSelect = modal.find('#editIssuedToUserId');
                userSelect.empty().append('<option value="">Select User</option>');
                if (userType) {
                    $.get(`{{ ADMIN }}/{{ API_GET_USERS_BY_ROLE }}/${userType}`, function (data) {
                        data.users.forEach(function (user) {
                            userSelect.append(new Option(user.name, user.id));
                        });
                        // Set the selected user AFTER populating options
                        if (issuedToUserId) {
                            userSelect.val(issuedToUserId);
                        }
                        userSelect.trigger('change');
                    }).fail(function () {
                        alert('Could not fetch users for the selected role.');
                    });
                }
            });

            // Dynamic User dropdown for Edit Modal
            $('#editUserType').on('change', function () {
                const roleName = $(this).val();
                const userSelect = $('#editIssuedToUserId');
                userSelect.empty().append('<option value="">Select User</option>');
                if (roleName) {
                    $.get(`{{ ADMIN }}/{{ API_GET_USERS_BY_ROLE }}/${roleName}`, function (data) {
                        data.users.forEach(function (user) {
                            userSelect.append(new Option(user.name, user.id));
                        });
                        userSelect.trigger('change');
                    }).fail(function () {
                        alert('Could not fetch users for the selected role.');
                    });
                }
            });

            $('#editItemId').on('change', function () {
                const itemId = $(this).val();
                fetchAvailableStock(itemId, $('#editItemStockInfo'));
            });


            // --- Return Issued Item Modal Logic ---
            $('#returnIssuedItemModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);
                const id = button.data('id');
                const itemName = button.data('item-name');
                const modal = $(this);
                modal.find('#returnIssuedItemForm').attr('action', `{{ ADMIN }}/{{ ISSUED_ITEMS_RETURN }}/${id}`);
                modal.find('#returnItemName').text(itemName);
            });

            // --- Approve Request Modal Logic ---
            $('#approveRequestModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);
                const id = button.data('id');
                const itemName = button.data('item-name');
                const modal = $(this);
                modal.find('#approveRequestForm').attr('action', `{{ ADMIN }}/{{ ISSUED_ITEMS_APPROVE_REQUEST }}/${id}`);
                modal.find('#approveItemName').text(itemName);
            });

            // --- Reject Request Modal Logic ---
            $('#rejectRequestModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);
                const id = button.data('id');
                const itemName = button.data('item-name');
                const modal = $(this);
                modal.find('#rejectRequestForm').attr('action', `{{ ADMIN }}/{{ ISSUED_ITEMS_REJECT_REQUEST }}/${id}`);
                modal.find('#rejectItemName').text(itemName);
            });

            // --- Delete Issued Item Modal Logic (Archive) ---
            $('#deleteIssuedItemModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);
                const id = button.data('id');
                const itemName = button.data('item-name');
                const modal = $(this);
                modal.find('#deleteIssuedItemForm').attr('action', `{{ ADMIN }}/{{ ISSUED_ITEMS_DELETE }}/${id}`);
                modal.find('#deleteItemName').text(itemName);
            });

            // --- Restore Issued Item Modal Logic ---
            $('#restoreIssuedItemModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);
                const id = button.data('id');
                const itemName = button.data('item-name');
                const modal = $(this);
                modal.find('#restoreIssuedItemForm').attr('action', `{{ ADMIN }}/{{ ISSUED_ITEMS_RESTORE }}/${id}`);
                modal.find('#restoreItemName').text(itemName);
            });
        });
    </script>
{% endblock %}